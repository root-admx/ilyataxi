<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞ –¥–ª—è —Ç–∞–∫—Å–∏</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Leaflet (OpenStreetMap) - –ë–ï–°–ü–õ–ê–¢–ù–û -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .header h1 {
            color: #333;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
        }
        
        #map {
            flex: 1;
            width: 100%;
        }
        
        .controls {
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .selected-address {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            min-height: 60px;
        }
        
        .selected-address h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .address-text {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #666;
        }
        
        .coordinates {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        .marker-popup {
            text-align: center;
            padding: 10px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .marker-popup h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .marker-popup p {
            color: #666;
            margin-bottom: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöï –í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</h1>
            <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É</p>
        </div>
        
        <div id="map"></div>
        
        <div class="controls">
            <div class="selected-address">
                <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å:</h3>
                <div class="address-text" id="addressText">
                    –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∞–¥—Ä–µ—Å...
                </div>
                <div class="coordinates" id="coordinatesText"></div>
            </div>
            
            <div class="loading" id="loading">
                ‚è≥ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å...
            </div>
            
            <button class="btn" id="confirmBtn" disabled>
                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å
            </button>
        </div>
    </div>

    <script>
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        let map;
        let marker = null;
        let selectedLatLng = null;
        let selectedAddress = "";
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const addressText = document.getElementById('addressText');
        const coordinatesText = document.getElementById('coordinatesText');
        const confirmBtn = document.getElementById('confirmBtn');
        const loading = document.getElementById('loading');
        
        // ==================== –¢–ï–õ–ï–ì–†–ê–ú –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        function initTelegram() {
            try {
                Telegram.WebApp.expand();
                Telegram.WebApp.setBackgroundColor('#667eea');
                Telegram.WebApp.setHeaderColor('#667eea');
                console.log('Telegram WebApp initialized');
            } catch (error) {
                console.log('Not in Telegram environment:', error);
            }
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ ====================
        function initMap() {
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É - –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            map = L.map('map').setView([55.7558, 37.6173], 13);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –∫–∞—Ä—Ç—ã OpenStreetMap - –ë–ï–°–ü–õ–ê–¢–ù–û!
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.on('click', onMapClick);
            
            // –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            locateUser();
            
            console.log('OpenStreetMap initialized');
        }
        
        // ==================== –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ú–ï–°–¢–û–ü–û–õ–û–ñ–ï–ù–ò–Ø ====================
        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;
                        
                        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                        map.setView([userLat, userLng], 15);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        L.marker([userLat, userLng])
                            .addTo(map)
                            .bindPopup('üìç –í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ')
                            .openPopup();
                            
                        console.log('User location found:', userLat, userLng);
                    },
                    function(error) {
                        console.log('Geolocation error:', error);
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    }
                );
            }
        }
        
        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–õ–ò–ö–ê –ü–û –ö–ê–†–¢–ï ====================
        function onMapClick(e) {
            selectedLatLng = e.latlng;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            loading.style.display = 'block';
            addressText.innerHTML = '–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å...';
            coordinatesText.textContent = `–®–∏—Ä–æ—Ç–∞: ${selectedLatLng.lat.toFixed(6)}, –î–æ–ª–≥–æ—Ç–∞: ${selectedLatLng.lng.toFixed(6)}`;
            confirmBtn.disabled = true;
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä–∫–µ—Ä
            if (marker) {
                map.removeLayer(marker);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
            marker = L.marker(selectedLatLng).addTo(map);
            
            // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            getAddressFromCoordinates(selectedLatLng.lat, selectedLatLng.lng);
        }
        
        // ==================== –ü–û–õ–£–ß–ï–ù–ò–ï –ê–î–†–ï–°–ê –ü–û –ö–û–û–†–î–ò–ù–ê–¢–ê–ú ====================
        function getAddressFromCoordinates(lat, lng) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Nominatim (OpenStreetMap) –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è - –ë–ï–°–ü–õ–ê–¢–ù–û!
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ru`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å
                    selectedAddress = formatAddress(data);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    addressText.innerHTML = `<strong>${selectedAddress}</strong>`;
                    coordinatesText.textContent = `–®–∏—Ä–æ—Ç–∞: ${lat.toFixed(6)}, –î–æ–ª–≥–æ—Ç–∞: ${lng.toFixed(6)}`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ø–∞–ø –º–∞—Ä–∫–µ—Ä–∞
                    marker.bindPopup(`
                        <div class="marker-popup">
                            <h3>‚úÖ –í—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å</h3>
                            <p>${selectedAddress}</p>
                            <p class="coordinates">${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                        </div>
                    `).openPopup();
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                    confirmBtn.disabled = false;
                    loading.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error getting address:', error);
                    
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    selectedAddress = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    addressText.innerHTML = `<strong>${selectedAddress}</strong><br>
                                           <small>–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å</small>`;
                    
                    marker.bindPopup(`
                        <div class="marker-popup">
                            <h3>üìç –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞</h3>
                            <p>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                        </div>
                    `).openPopup();
                    
                    confirmBtn.disabled = false;
                    loading.style.display = 'none';
                });
        }
        
        // ==================== –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –ê–î–†–ï–°–ê ====================
        function formatAddress(data) {
            if (!data || !data.address) {
                return "–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";
            }
            
            const addr = data.address;
            let addressParts = [];
            
            // –°–æ–±–∏—Ä–∞–µ–º –∞–¥—Ä–µ—Å –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–∞—Å—Ç–µ–π
            if (addr.road) addressParts.push(addr.road);
            if (addr.house_number) addressParts.push(addr.house_number);
            
            let formattedAddress = addressParts.join(', ');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥/—Ä–∞–π–æ–Ω –µ—Å–ª–∏ –µ—Å—Ç—å
            if (addr.city) {
                formattedAddress += `, ${addr.city}`;
            } else if (addr.town) {
                formattedAddress += `, ${addr.town}`;
            } else if (addr.village) {
                formattedAddress += `, ${addr.village}`;
            } else if (addr.municipality) {
                formattedAddress += `, ${addr.municipality}`;
            }
            
            // –ï—Å–ª–∏ –∞–¥—Ä–µ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º display_name
            if (formattedAddress.length < 5 && data.display_name) {
                // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å –¥–ª–∏–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞
                const parts = data.display_name.split(',');
                formattedAddress = parts.slice(0, 3).join(', ');
            }
            
            return formattedAddress || data.display_name || "–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";
        }
        
        // ==================== –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –í–´–ë–û–†–ê ====================
        function confirmSelection() {
            if (!selectedLatLng || !selectedAddress) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏
            const pointData = {
                lat: selectedLatLng.lat,
                lon: selectedLatLng.lng,
                address: selectedAddress
            };
            
            console.log('Sending data to bot:', pointData);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram –±–æ—Ç
            try {
                Telegram.WebApp.sendData(JSON.stringify(pointData));
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                confirmBtn.textContent = '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
                confirmBtn.style.background = '#28a745';
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    Telegram.WebApp.close();
                }, 1000);
                
            } catch (error) {
                console.error('Error sending data:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            }
        }
        
        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================
        confirmBtn.addEventListener('click', confirmSelection);
        
        // ==================== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', function() {
            initTelegram();
            initMap();
        });
    </script>
</body>
</html>
