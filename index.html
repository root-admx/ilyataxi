<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞ –¥–ª—è —Ç–∞–∫—Å–∏</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=08947073-5246-4a31-8dcc-e5f8242d06a6&lang=ru_RU" type="text/javascript"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            border-bottom: 1px solid #e9ecef;
        }
        
        .header h1 {
            color: #333;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
        }
        
        #map {
            flex: 1;
            width: 100%;
        }
        
        .controls {
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            border-top: 1px solid #e9ecef;
        }
        
        .selected-address {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .selected-address h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .address-text {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .coordinates {
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
        }
        
        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #666;
        }
        
        .status-message {
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöï –í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</h1>
            <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É</p>
        </div>
        
        <div id="map"></div>
        
        <div class="controls">
            <div class="status-message" id="statusMessage"></div>
            
            <div class="selected-address">
                <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å:</h3>
                <div class="address-text" id="addressText">
                    –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∞–¥—Ä–µ—Å...
                </div>
                <div class="coordinates" id="coordinatesText"></div>
            </div>
            
            <div class="loading" id="loading">
                ‚è≥ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å...
            </div>
            
            <button class="btn" id="confirmBtn" onclick="confirmSelection()" disabled>
                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å
            </button>
        </div>
    </div>

    <script>
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        let map;
        let selectedPlacemark = null;
        let selectedCoordinates = null;
        let selectedAddress = "";
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const addressText = document.getElementById('addressText');
        const coordinatesText = document.getElementById('coordinatesText');
        const confirmBtn = document.getElementById('confirmBtn');
        const loading = document.getElementById('loading');
        const statusMessage = document.getElementById('statusMessage');

        // ==================== –¢–ï–õ–ï–ì–†–ê–ú –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        function initTelegram() {
            try {
                Telegram.WebApp.expand();
                Telegram.WebApp.ready();
                console.log('Telegram WebApp initialized');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ WebApp —Ä–∞–±–æ—Ç–∞–µ—Ç
                if (typeof Telegram.WebApp.sendData === 'function') {
                    console.log('sendData function is available');
                } else {
                    console.error('sendData function is NOT available');
                }
                
            } catch (error) {
                console.log('Not in Telegram environment:', error);
                showStatus('‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ–º –≤–Ω–µ Telegram', 'error');
            }
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –Ø–ù–î–ï–ö–°.–ö–ê–†–¢ ====================
        function initMap() {
            ymaps.ready(function() {
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
                map = new ymaps.Map('map', {
                    center: [55.7558, 37.6173],
                    zoom: 12
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
                map.events.add('click', onMapClick);

                // –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                locateUser();

                console.log('Yandex Map initialized');
            });
        }

        // ==================== –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ú–ï–°–¢–û–ü–û–õ–û–ñ–ï–ù–ò–Ø ====================
        function locateUser() {
            ymaps.geolocation.get({
                provider: 'browser'
            }).then(function(result) {
                map.setCenter(result.geoObjects.position, 15);
                
                new ymaps.Placemark(
                    result.geoObjects.position,
                    {
                        hintContent: '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ',
                        balloonContent: '–í—ã –∑–¥–µ—Å—å'
                    },
                    {
                        preset: 'islands#blueCircleIcon'
                    }
                ).addTo(map.geoObjects);
                
            }).catch(function(error) {
                console.log('Geolocation error:', error);
            });
        }

        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–õ–ò–ö–ê –ü–û –ö–ê–†–¢–ï ====================
        function onMapClick(e) {
            const coords = e.get('coords');
            selectedCoordinates = coords;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            loading.style.display = 'block';
            hideStatus();
            addressText.innerHTML = '–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å...';
            coordinatesText.textContent = `–®–∏—Ä–æ—Ç–∞: ${coords[0].toFixed(6)}, –î–æ–ª–≥–æ—Ç–∞: ${coords[1].toFixed(6)}`;
            confirmBtn.disabled = true;

            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä–∫–µ—Ä
            if (selectedPlacemark) {
                map.geoObjects.remove(selectedPlacemark);
            }

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
            selectedPlacemark = new ymaps.Placemark(
                coords,
                {
                    hintContent: '–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å...',
                    balloonContent: '–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å...'
                },
                {
                    preset: 'islands#grayIcon'
                }
            );
            
            map.geoObjects.add(selectedPlacemark);

            // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            getAddressFromCoordinates(coords[0], coords[1]);
        }

        // ==================== –ü–û–õ–£–ß–ï–ù–ò–ï –ê–î–†–ï–°–ê –ü–û –ö–û–û–†–î–ò–ù–ê–¢–ê–ú ====================
        function getAddressFromCoordinates(lat, lng) {
            ymaps.geocode([lat, lng]).then(function(res) {
                const firstGeoObject = res.geoObjects.get(0);
                
                if (firstGeoObject) {
                    selectedAddress = firstGeoObject.getAddress();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É
                    updatePlacemark(lat, lng, selectedAddress, 'success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    addressText.innerHTML = `<strong>${selectedAddress}</strong>`;
                    coordinatesText.textContent = `–®–∏—Ä–æ—Ç–∞: ${lat.toFixed(6)}, –î–æ–ª–≥–æ—Ç–∞: ${lng.toFixed(6)}`;
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                    confirmBtn.disabled = false;
                    loading.style.display = 'none';
                    showStatus('‚úÖ –ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω! –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å"', 'success');
                    
                } else {
                    // –ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
                    handleNoAddress(lat, lng);
                }
            }).catch(function(error) {
                console.error('Geocoding error:', error);
                handleNoAddress(lat, lng);
            });
        }

        // ==================== –û–ë–†–ê–ë–û–¢–ö–ê –°–õ–£–ß–ê–Ø –ö–û–ì–î–ê –ê–î–†–ï–° –ù–ï –ù–ê–ô–î–ï–ù ====================
        function handleNoAddress(lat, lng) {
            selectedAddress = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            
            updatePlacemark(lat, lng, '–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            
            addressText.innerHTML = `<strong>${selectedAddress}</strong>`;
            coordinatesText.textContent = `–®–∏—Ä–æ—Ç–∞: ${lat.toFixed(6)}, –î–æ–ª–≥–æ—Ç–∞: ${lng.toFixed(6)}`;
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –¥–∞–∂–µ –µ—Å–ª–∏ –∞–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
            confirmBtn.disabled = false;
            loading.style.display = 'none';
            showStatus('‚ö†Ô∏è –ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã', 'error');
        }

        // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ú–ï–¢–ö–ò –ù–ê –ö–ê–†–¢–ï ====================
        function updatePlacemark(lat, lng, address, status) {
            if (selectedPlacemark) {
                map.geoObjects.remove(selectedPlacemark);
            }
            
            let preset = 'islands#redIcon';
            let balloonContent = `‚ùå –ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω<br>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            
            if (status === 'success') {
                preset = 'islands#greenIcon';
                balloonContent = `‚úÖ –ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω:<br>${address}`;
            }
            
            selectedPlacemark = new ymaps.Placemark(
                [lat, lng],
                {
                    hintContent: address,
                    balloonContent: balloonContent
                },
                {
                    preset: preset,
                    balloonCloseButton: false
                }
            );
            
            map.geoObjects.add(selectedPlacemark);
            selectedPlacemark.balloon.open();
        }

        // ==================== –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –í–´–ë–û–†–ê ====================
        function confirmSelection() {
            if (!selectedCoordinates) {
                showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ', 'error');
                return;
            }
            
            // –ï—Å–ª–∏ –∞–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            if (!selectedAddress) {
                selectedAddress = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${selectedCoordinates[0].toFixed(6)}, ${selectedCoordinates[1].toFixed(6)}`;
            }
            
            const pointData = {
                lat: selectedCoordinates[0],
                lon: selectedCoordinates[1],
                address: selectedAddress
            };
            
            console.log('Preparing to send data:', pointData);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏
            showStatus('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ...', 'success');
            confirmBtn.disabled = true;
            confirmBtn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            try {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫—É
                const dataString = JSON.stringify(pointData);
                console.log('Sending data string:', dataString);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ sendData
                if (typeof Telegram.WebApp.sendData !== 'function') {
                    throw new Error('sendData function not available');
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                Telegram.WebApp.sendData(dataString);
                
                console.log('Data sent successfully');
                showStatus('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É...', 'success');
                confirmBtn.textContent = '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    if (typeof Telegram.WebApp.close === 'function') {
                        Telegram.WebApp.close();
                    } else {
                        showStatus('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –≤—Ä—É—á–Ω—É—é', 'success');
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error sending data:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message, 'error');
                confirmBtn.disabled = false;
                confirmBtn.textContent = '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å';
            }
        }

        // ==================== –ü–û–ö–ê–ó–ê–¢–¨ –°–¢–ê–¢–£–° ====================
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message';
            
            if (type === 'success') {
                statusMessage.classList.add('status-success');
            } else if (type === 'error') {
                statusMessage.classList.add('status-error');
            }
            
            statusMessage.style.display = 'block';
        }

        // ==================== –°–ö–†–´–¢–¨ –°–¢–ê–¢–£–° ====================
        function hideStatus() {
            statusMessage.style.display = 'none';
        }

        // ==================== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initTelegram();
            initMap();
        });
    </script>
</body>
</html>
