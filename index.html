<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор адреса</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial; }
        #map { width: 100%; height: 80vh; }
        .controls { padding: 15px; background: white; }
        .btn { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; }
        .btn:disabled { background: #ccc; }
        .info { padding: 10px; background: #f8f9fa; margin-bottom: 10px; border-radius: 6px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <div class="info">
            <strong>Выбранный адрес:</strong><br>
            <span id="address">Нажмите на карту</span><br>
            <small id="coords"></small>
        </div>
        <button class="btn" id="confirmBtn" disabled>✅ Подтвердить адрес</button>
    </div>

    <script>
        // Простая версия без Яндекс.Карт - используем координаты
        let selectedCoords = null;
        let selectedAddress = "Адрес не определен";

        function initMap() {
            // Просим пользователя разрешить геолокацию
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    selectedCoords = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    document.getElementById('address').textContent = "Ваше местоположение";
                    document.getElementById('coords').textContent = `Координаты: ${selectedCoords.lat.toFixed(6)}, ${selectedCoords.lon.toFixed(6)}`;
                    document.getElementById('confirmBtn').disabled = false;
                });
            }

            // Показываем инструкцию
            document.getElementById('address').textContent = "Разрешите геолокацию или введите адрес вручную";
            document.getElementById('confirmBtn').disabled = false;
        }

        function confirmSelection() {
            if (!selectedCoords) {
                // Если координат нет, создаем фиктивные
                selectedCoords = { lat: 55.7558, lon: 37.6176 };
                selectedAddress = "Адрес введен вручную";
            }

            const data = {
                lat: selectedCoords.lat,
                lon: selectedCoords.lon,
                address: selectedAddress
            };

            console.log("Отправляем данные:", data);
            
            try {
                Telegram.WebApp.sendData(JSON.stringify(data));
                alert("✅ Адрес отправлен! Закрываем карту...");
                Telegram.WebApp.close();
            } catch (error) {
                console.error("Ошибка:", error);
                alert("❌ Ошибка отправки: " + error.message);
            }
        }

        // Инициализация
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        document.getElementById('confirmBtn').onclick = confirmSelection;
        initMap();
    </script>
</body>
</html>
